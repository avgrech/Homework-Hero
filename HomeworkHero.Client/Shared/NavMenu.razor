@implements IDisposable

<aside class="sidebar">
    <div class="user-panel">
        <div class="user-avatar">@UserInitials</div>
        <div class="user-meta">
            <div class="user-name">@UserLabel</div>
            <div class="user-role">@UserRole</div>
        </div>
        @if (authState.IsAuthenticated)
        {
            <button class="link logout" @onclick="Logout">Logout</button>
        }
    </div>

    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Overview</div>
            <NavLink href="/" Match="NavLinkMatch.All" class="nav-link" ActiveClass="active">
                <span class="nav-icon" aria-hidden="true">ğŸ </span>
                <span>Home</span>
            </NavLink>
            @if (!IsStudent)
            {
                <NavLink href="/teacher-dashboard" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ“Š</span>
                    <span>Teacher dashboard</span>
                </NavLink>
            }
        </div>

        <div class="nav-section">
            <div class="nav-section-title">People & Homework</div>
            @if (IsStudent)
            {
                <NavLink href="/student-homework" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ“š</span>
                    <span>My homework</span>
                </NavLink>
            }
            else if (IsTeacher)
            {
                <NavLink href="/students" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ‘¥</span>
                    <span>My students</span>
                </NavLink>
                <NavLink href="/homework" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ“</span>
                    <span>Homework</span>
                </NavLink>
                <NavLink href="/student-homework" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ“š</span>
                    <span>Student homework</span>
                </NavLink>
            }
            else
            {
                <NavLink href="/students" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ‘¥</span>
                    <span>Students</span>
                </NavLink>
                <NavLink href="/teachers" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ‘©â€ğŸ«</span>
                    <span>Teachers</span>
                </NavLink>
                <NavLink href="/homework" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ“</span>
                    <span>Homework</span>
                </NavLink>
                <NavLink href="/student-homework" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ“š</span>
                    <span>Student homework</span>
                </NavLink>
            }
        </div>

        @if (authState.IsAuthenticated && string.Equals(authState.Role, "Admin", StringComparison.OrdinalIgnoreCase))
        {
            <div class="nav-section">
                <div class="nav-section-title">Administration</div>
                <NavLink href="/admin" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ› ï¸</span>
                    <span>Admin</span>
                </NavLink>
                <NavLink href="/admin/classrooms" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ«</span>
                    <span>Classrooms</span>
                </NavLink>
            </div>
        }

        @if (!authState.IsAuthenticated)
        {
            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <NavLink href="/login" class="nav-link" ActiveClass="active">
                    <span class="nav-icon" aria-hidden="true">ğŸ”</span>
                    <span>Login</span>
                </NavLink>
            </div>
        }
    </nav>
</aside>

@code {
    [Inject]
    private AuthState authState { get; set; } = default!;

    private bool IsStudent => string.Equals(authState.Role, "Student", StringComparison.OrdinalIgnoreCase);
    private bool IsTeacher => string.Equals(authState.Role, "Teacher", StringComparison.OrdinalIgnoreCase);

    private string UserLabel => authState.IsAuthenticated ? authState.Email : "Guest visitor";
    private string UserRole => authState.IsAuthenticated ? authState.Role : "Not signed in";
    private string UserInitials
        => authState.IsAuthenticated
            ? (string.IsNullOrWhiteSpace(authState.Email) ? "?" : authState.Email![0].ToString().ToUpperInvariant())
            : "?";

    protected override void OnInitialized()
    {
        authState.OnChange += Refresh;
    }

    private void Refresh()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task Logout()
    {
        await authState.ClearAsync();
    }

    public void Dispose()
    {
        authState.OnChange -= Refresh;
    }
}
