@page "/admin/conditions"
@inject HttpClient Http
@inject AuthState Auth

<h1>Conditions</h1>
<p>Add and manage the conditions that can be linked to student profiles.</p>

@if (!IsAdmin)
{
    <p class="text-error">You must be signed in as an admin to use this page.</p>
    <NavLink href="/login">Go to login</NavLink>
}
else
{
    <section class="card">
        <h2>Add a condition</h2>
        <p>Use short names so staff can quickly tag a student record.</p>

        @if (!string.IsNullOrWhiteSpace(StatusMessage))
        {
            <p class="@(IsError ? "text-error" : "text-success")">@StatusMessage</p>
        }

        <EditForm Model="newCondition" OnValidSubmit="CreateCondition">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="grid">
                <div>
                    <label>Name</label>
                    <InputText @bind-Value="newCondition.Name" />
                </div>
                <div>
                    <label>Description</label>
                    <InputTextArea @bind-Value="newCondition.Description" />
                </div>
            </div>
            <button type="submit" disabled="@IsSubmitting">@((IsSubmitting ? "Saving..." : "Add condition"))</button>
        </EditForm>
    </section>

    <section class="card">
        <h2>Existing conditions</h2>
        @if (conditions.Count == 0)
        {
            <p>No conditions added yet.</p>
        }
        else
        {
            <div class="grid">
                @foreach (var condition in conditions)
                {
                    var editor = GetEditor(condition.Id);
                    <div class="callout">
                        @if (editor.IsEditing)
                        {
                            <div class="stacked-form">
                                <div>
                                    <label>Name</label>
                                    <InputText @bind-Value="editor.Name" />
                                </div>
                                <div>
                                    <label>Description</label>
                                    <InputTextArea @bind-Value="editor.Description" />
                                </div>
                            </div>
                        }
                        else
                        {
                            <h3>@condition.Name</h3>
                            @if (!string.IsNullOrWhiteSpace(condition.Description))
                            {
                                <p>@condition.Description</p>
                            }
                            else
                            {
                                <p class="muted">No description provided.</p>
                            }
                            <p class="muted">Assigned to @condition.AssignedStudentCount student(s).</p>
                        }

                        <div class="form-actions">
                            @if (editor.IsEditing)
                            {
                                <button type="button" class="primary" disabled="@IsSaving(condition.Id)" @onclick="() => SaveCondition(condition.Id)">Save</button>
                                <button type="button" class="ghost" @onclick="() => CancelEdit(condition.Id)">Cancel</button>
                            }
                            else
                            {
                                <button type="button" class="ghost" @onclick="() => StartEdit(condition.Id)">Edit</button>
                                <button type="button" class="ghost" disabled="@IsDeleting(condition.Id)" @onclick="() => ConfirmDelete(condition)">Delete</button>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </section>
}

@if (showDeleteModal && deleteTarget is not null)
{
    <div class="modal-backdrop" @onclick="CloseDeleteModal">
        <div class="modal-panel" @onclick:stopPropagation>
            <header class="modal-header">
                <div>
                    <p class="eyebrow">Delete condition</p>
                    <h3>@deleteTarget.Name</h3>
                </div>
                <button class="ghost" @onclick="CloseDeleteModal" aria-label="Close">âœ•</button>
            </header>

            <p>
                This condition is assigned to <strong>@deleteTarget.AssignedStudentCount</strong> student(s).
                Choose how to handle those assignments before deleting it.
            </p>

            <div class="stacked-form">
                <div>
                    <label>Assign a replacement condition</label>
                    <InputSelect @bind-Value="replacementConditionId">
                        <option value="">Select a condition</option>
                        @foreach (var option in ReplacementConditions)
                        {
                            <option value="@option.Id">@option.Name</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="ghost" @onclick="CloseDeleteModal">Cancel</button>
                <button type="button" class="primary" disabled="@(!replacementConditionId.HasValue)" @onclick="ConfirmReplacementDelete">
                    Assign replacement condition
                </button>
                <button type="button" class="ghost" @onclick="ConfirmRemoveAssignments">
                    Remove condition from students
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<ConditionSummaryDto> conditions = new();
    private Condition newCondition = new();
    private string? StatusMessage;
    private bool IsError;
    private bool IsSubmitting;
    private readonly Dictionary<int, ConditionEditor> editors = new();
    private readonly HashSet<int> savingConditionIds = new();
    private readonly HashSet<int> deletingConditionIds = new();
    private bool showDeleteModal;
    private ConditionSummaryDto? deleteTarget;
    private int? replacementConditionId;

    private bool IsAdmin => Auth.IsAuthenticated && string.Equals(Auth.Role, "Admin", StringComparison.OrdinalIgnoreCase);
    private IEnumerable<ConditionSummaryDto> ReplacementConditions =>
        deleteTarget is null
            ? Enumerable.Empty<ConditionSummaryDto>()
            : conditions.Where(c => c.Id != deleteTarget.Id);

    protected override async Task OnInitializedAsync()
    {
        if (!IsAdmin)
        {
            return;
        }

        await LoadConditions();
    }

    private async Task LoadConditions()
    {
        try
        {
            conditions = await Http.GetFromJsonAsync<List<ConditionSummaryDto>>("api/conditions") ?? new();
            conditions = conditions.OrderBy(c => c.Name).ToList();
            SyncEditors();
        }
        catch
        {
            StatusMessage = "Unable to load conditions right now.";
            IsError = true;
            conditions = new();
            editors.Clear();
        }
    }

    private async Task CreateCondition()
    {
        if (string.IsNullOrWhiteSpace(newCondition.Name))
        {
            StatusMessage = "Please enter a condition name.";
            IsError = true;
            return;
        }

        IsSubmitting = true;
        IsError = false;
        StatusMessage = null;

        var response = await Http.PostAsJsonAsync("api/conditions", newCondition);
        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Condition added.";
            newCondition = new Condition();
            await LoadConditions();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to add condition." : error;
            IsError = true;
        }

        IsSubmitting = false;
    }

    private ConditionEditor GetEditor(int conditionId)
    {
        if (!editors.TryGetValue(conditionId, out var editor))
        {
            editor = new ConditionEditor();
            editors[conditionId] = editor;
        }

        return editor;
    }

    private void SyncEditors()
    {
        var knownIds = conditions.Select(c => c.Id).ToHashSet();
        var staleIds = editors.Keys.Where(id => !knownIds.Contains(id)).ToList();
        foreach (var id in staleIds)
        {
            editors.Remove(id);
        }

        foreach (var condition in conditions)
        {
            if (!editors.TryGetValue(condition.Id, out var editor))
            {
                editors[condition.Id] = new ConditionEditor
                {
                    Name = condition.Name,
                    Description = condition.Description
                };
            }
            else if (!editor.IsEditing)
            {
                editor.Name = condition.Name;
                editor.Description = condition.Description;
            }
        }
    }

    private void StartEdit(int conditionId)
    {
        if (editors.TryGetValue(conditionId, out var editor))
        {
            editor.IsEditing = true;
        }
    }

    private void CancelEdit(int conditionId)
    {
        if (editors.TryGetValue(conditionId, out var editor))
        {
            var condition = conditions.FirstOrDefault(c => c.Id == conditionId);
            if (condition is not null)
            {
                editor.Name = condition.Name;
                editor.Description = condition.Description;
            }

            editor.IsEditing = false;
        }
    }

    private async Task SaveCondition(int conditionId)
    {
        if (!editors.TryGetValue(conditionId, out var editor))
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(editor.Name))
        {
            StatusMessage = "Please enter a condition name.";
            IsError = true;
            return;
        }

        savingConditionIds.Add(conditionId);
        StatusMessage = null;
        IsError = false;

        var update = new ConditionUpdateRequest(editor.Name, editor.Description);
        var response = await Http.PutAsJsonAsync($"api/conditions/{conditionId}", update);
        if (response.IsSuccessStatusCode)
        {
            var updated = await response.Content.ReadFromJsonAsync<ConditionSummaryDto>();
            if (updated is not null)
            {
                var index = conditions.FindIndex(c => c.Id == conditionId);
                if (index >= 0)
                {
                    conditions[index] = updated;
                }

                editor.Name = updated.Name;
                editor.Description = updated.Description;
                editor.IsEditing = false;
                StatusMessage = "Condition updated.";
            }

            SyncEditors();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to update condition." : error;
            IsError = true;
        }

        savingConditionIds.Remove(conditionId);
    }

    private void ConfirmDelete(ConditionSummaryDto condition)
    {
        if (condition.AssignedStudentCount > 0)
        {
            deleteTarget = condition;
            replacementConditionId = null;
            showDeleteModal = true;
            return;
        }

        _ = DeleteCondition(condition, null);
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        deleteTarget = null;
        replacementConditionId = null;
    }

    private async Task ConfirmReplacementDelete()
    {
        if (deleteTarget is null || !replacementConditionId.HasValue)
        {
            return;
        }

        var request = new ConditionDeleteRequest(replacementConditionId, false);
        await DeleteCondition(deleteTarget, request);
        CloseDeleteModal();
    }

    private async Task ConfirmRemoveAssignments()
    {
        if (deleteTarget is null)
        {
            return;
        }

        var request = new ConditionDeleteRequest(null, true);
        await DeleteCondition(deleteTarget, request);
        CloseDeleteModal();
    }

    private async Task DeleteCondition(ConditionSummaryDto condition, ConditionDeleteRequest? request)
    {
        deletingConditionIds.Add(condition.Id);
        StatusMessage = null;
        IsError = false;

        HttpResponseMessage response;
        if (request is null)
        {
            response = await Http.DeleteAsync($"api/conditions/{condition.Id}");
        }
        else
        {
            var message = new HttpRequestMessage(HttpMethod.Delete, $"api/conditions/{condition.Id}")
            {
                Content = JsonContent.Create(request)
            };
            response = await Http.SendAsync(message);
        }

        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Condition deleted.";
            await LoadConditions();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to delete condition." : error;
            IsError = true;
        }

        deletingConditionIds.Remove(condition.Id);
    }

    private bool IsSaving(int conditionId) => savingConditionIds.Contains(conditionId);

    private bool IsDeleting(int conditionId) => deletingConditionIds.Contains(conditionId);

    private sealed class ConditionEditor
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool IsEditing { get; set; }
    }
}
