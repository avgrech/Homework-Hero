@page "/admin/classrooms"
@inject HttpClient Http
@inject AuthState Auth

<h1>Classroom assignments</h1>
<p>Assign students to classroom groups and connect those classrooms to teachers.</p>

@if (!IsAdmin)
{
    <p class="text-error">You must be signed in as an admin to use this page.</p>
    <NavLink href="/login">Go to login</NavLink>
}
else
{
    <section class="card">
        <h2>Assign students to a classroom</h2>
        <p>Select a teacher, enter a classroom name (group ID), and choose which students belong in that classroom.</p>

        @if (!string.IsNullOrWhiteSpace(StatusMessage))
        {
            <p class="@(IsError ? "text-error" : "text-success")">@StatusMessage</p>
        }

        <EditForm Model="assignment" OnValidSubmit="SubmitAssignment">
            <DataAnnotationsValidator />
            <div class="grid">
                <div>
                    <label>Teacher</label>
                    <InputSelect @bind-Value="assignment.TeacherId">
                        <option value="0">Select a teacher</option>
                        @foreach (var teacher in teachers)
                        {
                            <option value="@teacher.Id">@teacher.FirstName @teacher.LastName (@teacher.Email)</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Classroom / Group ID</label>
                    <InputText @bind-Value="assignment.GroupId" list="group-options" />
                    <datalist id="group-options">
                        @foreach (var group in classrooms.Select(c => c.GroupId).Distinct())
                        {
                            <option value="@group"></option>
                        }
                    </datalist>
                </div>
            </div>

            <div class="student-selector">
                <h3>Select students</h3>
                <p class="muted">Choose one or more students to place in the classroom.</p>
                <InputText @bind-Value="studentSearch" placeholder="Search by name or email" oninput="oninput" />
                <div class="student-grid">
                    @foreach (var student in FilteredStudents)
                    {
                        <label>
                            <input type="checkbox" @checked="assignment.StudentIds.Contains(student.Id)" @onchange="() => ToggleStudent(student.Id)" />
                            @student.FirstName @student.LastName (@student.Email)
                        </label>
                    }
                </div>
            </div>

            <div class="button-row">
                <button type="submit" disabled="@IsSubmitting">@((IsSubmitting ? "Saving..." : "Save classroom"))</button>
                <button type="button" @onclick="CreateClassroom" disabled="@IsSubmitting">Create classroom</button>
            </div>
        </EditForm>
    </section>

    <section class="card">
        <h2>Current classrooms</h2>
        @if (classrooms.Count == 0)
        {
            <p>No classroom assignments yet.</p>
        }
        else
        {
            <div class="grid">
                @foreach (var classroom in classrooms)
                {
                    <div class="callout">
                        <p class="muted">Group</p>
                        <h3>@classroom.GroupId</h3>
                        <p><strong>Teacher:</strong> @classroom.TeacherName</p>
                        <p><strong>Students:</strong></p>
                        @if (classroom.Students.Count == 0)
                        {
                            <p class="muted">No students assigned yet.</p>
                        }
                        else
                        {
                            <ul>
                                @foreach (var student in classroom.Students)
                                {
                                    <li>@student.FirstName @student.LastName</li>
                                }
                            </ul>
                        }
                    </div>
                }
            </div>
        }
    </section>
}

@code {
    private List<Teacher> teachers = new();
    private List<Student> students = new();
    private List<ClassroomSummaryDto> classrooms = new();
    private string studentSearch = string.Empty;
    private ClassroomAssignmentRequest assignment = new()
    {
        TeacherId = 0,
        GroupId = string.Empty,
        StudentIds = new(),
    };

    private string? StatusMessage;
    private bool IsError;
    private bool IsSubmitting;

    private bool IsAdmin => Auth.IsAuthenticated && string.Equals(Auth.Role, "Admin", StringComparison.OrdinalIgnoreCase);

    private IEnumerable<Student> FilteredStudents => string.IsNullOrWhiteSpace(studentSearch)
        ? students
        : students.Where(s =>
            s.FirstName.Contains(studentSearch, StringComparison.OrdinalIgnoreCase) ||
            s.LastName.Contains(studentSearch, StringComparison.OrdinalIgnoreCase) ||
            s.Email.Contains(studentSearch, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        teachers = await FetchOrEmpty("api/teachers") ?? new();
        students = await FetchOrEmpty("api/students") ?? new();
        classrooms = await FetchOrEmpty("api/admin/classrooms") ?? new();
    }

    private async Task<List<T>?> FetchOrEmpty<T>(string requestUri)
    {
        try
        {
            return await Http.GetFromJsonAsync<List<T>>(requestUri) ?? new();
        }
        catch
        {
            StatusMessage = $"Unable to load data from '{requestUri}'.";
            IsError = true;
            return new();
        }
    }

    private void ToggleStudent(int studentId)
    {
        if (assignment.StudentIds.Contains(studentId))
        {
            assignment.StudentIds.Remove(studentId);
        }
        else
        {
            assignment.StudentIds.Add(studentId);
        }
    }

    private async Task SubmitAssignment()
    {
        if (assignment.TeacherId == 0 || string.IsNullOrWhiteSpace(assignment.GroupId) || assignment.StudentIds.Count == 0)
        {
            StatusMessage = "Please choose a teacher, classroom, and at least one student.";
            IsError = true;
            return;
        }

        IsSubmitting = true;
        IsError = false;
        StatusMessage = null;

        var response = await Http.PostAsJsonAsync("api/admin/classrooms/assign", assignment);
        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Classroom saved.";
            assignment = new()
            {
                TeacherId = assignment.TeacherId,
                GroupId = assignment.GroupId,
                StudentIds = new List<int>(),
            };
            await LoadData();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to save classroom." : error;
            IsError = true;
        }

        IsSubmitting = false;
    }

    private async Task CreateClassroom()
    {
        if (assignment.TeacherId == 0 || string.IsNullOrWhiteSpace(assignment.GroupId))
        {
            StatusMessage = "Please choose a teacher and classroom name.";
            IsError = true;
            return;
        }

        IsSubmitting = true;
        IsError = false;
        StatusMessage = null;

        var request = new CreateClassroomRequest
        {
            TeacherId = assignment.TeacherId,
            GroupId = assignment.GroupId
        };

        var response = await Http.PostAsJsonAsync("api/admin/classrooms", request);
        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Classroom created.";
            await LoadData();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to create classroom." : error;
            IsError = true;
        }

        IsSubmitting = false;
    }
}
