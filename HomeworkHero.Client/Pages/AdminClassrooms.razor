@page "/admin/classrooms"
@inject HttpClient Http
@inject AuthState Auth

<h1>Classroom assignments</h1>
<p>Assign students to classroom groups and connect those classrooms to teachers.</p>

@if (!IsAdmin)
{
    <p class="text-error">You must be signed in as an admin to use this page.</p>
    <NavLink href="/login">Go to login</NavLink>
}
else
{
    <section class="card">
        <h2>Assign students to a classroom</h2>
        <p>Select a teacher, enter a classroom name (group ID), and choose which students belong in that classroom.</p>

        @if (!string.IsNullOrWhiteSpace(StatusMessage))
        {
            <p class="@(IsError ? "text-error" : "text-success")">@StatusMessage</p>
        }

        <EditForm Model="assignment" OnValidSubmit="SubmitAssignment">
            <DataAnnotationsValidator />
            <div class="grid">
                <div>
                    <label>Teacher</label>
                    <InputSelect @bind-Value="assignment.TeacherId">
                        <option value="0">Select a teacher</option>
                        @foreach (var teacher in teachers)
                        {
                            <option value="@teacher.Id">@teacher.FirstName @teacher.LastName (@teacher.Email)</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Classroom / Group ID</label>
                    <InputText @bind-Value="assignment.GroupId" list="group-options" />
                    <datalist id="group-options">
                        @foreach (var group in classrooms.Select(c => c.GroupId).Distinct())
                        {
                            <option value="@group"></option>
                        }
                    </datalist>
                </div>
            </div>

            <div class="student-selector">
                <h3>Select students</h3>
                <p class="muted">Choose one or more students to place in the classroom.</p>
                <InputText @bind-Value="studentSearch" placeholder="Search by name or email" oninput="oninput" />
                <div class="student-grid">
                    @foreach (var student in FilteredStudents)
                    {
                        <label>
                            <input
                                type="checkbox"
                                @checked="assignment.StudentIds.Contains(student.Id)"
                                @onchange="() => ToggleStudent(student.Id)" />
                            @student.FirstName @student.LastName (@student.Email)
                        </label>
                    }
                </div>
            </div>

            <button type="submit" disabled="@IsSubmitting">@((IsSubmitting ? "Saving..." : "Save classroom"))</button>
        </EditForm>
    </section>

    <section class="card">
        <h2>Add a teacher to an existing classroom</h2>
        <p>Assign a second teacher to the students already in a classroom group.</p>

        @if (!string.IsNullOrWhiteSpace(TeacherStatusMessage))
        {
            <p class="@(TeacherIsError ? "text-error" : "text-success")">@TeacherStatusMessage</p>
        }

        <EditForm Model="teacherAssignment" OnValidSubmit="AddTeacherToClassroom">
            <DataAnnotationsValidator />
            <div class="grid">
                <div>
                    <label>Teacher</label>
                    <InputSelect @bind-Value="teacherAssignment.TeacherId">
                        <option value="0">Select a teacher</option>
                        @foreach (var teacher in teachers)
                        {
                            <option value="@teacher.Id">@teacher.FirstName @teacher.LastName (@teacher.Email)</option>
                        }
                    </InputSelect>
                </div>
                <div>
                    <label>Classroom / Group ID</label>
                    <InputSelect @bind-Value="teacherAssignment.GroupId">
                        <option value="">Select a classroom</option>
                        @foreach (var group in ClassroomGroups)
                        {
                            <option value="@group">@group</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <button type="submit" disabled="@IsTeacherSubmitting">@((IsTeacherSubmitting ? "Adding..." : "Add teacher"))</button>
        </EditForm>
    </section>

    <section class="card">
        <h2>Current classrooms</h2>
        @if (classrooms.Count == 0)
        {
            <p>No classroom assignments yet.</p>
        }
        else
        {
            <div class="grid">
                @foreach (var classroom in classrooms)
                {
                    <div class="callout">
                        <p class="muted">Group</p>
                        <h3>@classroom.GroupId</h3>
                        <p><strong>Teacher:</strong> @classroom.TeacherName</p>
                        <p><strong>Students:</strong></p>
                        @if (classroom.Students.Count == 0)
                        {
                            <p class="muted">No students assigned yet.</p>
                        }
                        else
                        {
                            <ul>
                                @foreach (var student in classroom.Students)
                                {
                                    <li>@student.FirstName @student.LastName</li>
                                }
                            </ul>
                        }
                    </div>
                }
            </div>
        }
    </section>
}

@code {
    private List<Teacher> teachers = new();
    private List<Student> students = new();
    private List<ClassroomSummaryDto> classrooms = new();
    private string studentSearch = string.Empty;
    private ClassroomAssignmentRequest assignment = new()
    {
        TeacherId = 0,
        GroupId = string.Empty,
        StudentIds = new(),
    };

    private AddTeacherToClassroomRequest teacherAssignment = new()
    {
        TeacherId = 0,
        GroupId = string.Empty
    };

    private string? StatusMessage;
    private bool IsError;
    private bool IsSubmitting;

    private string? TeacherStatusMessage;
    private bool TeacherIsError;
    private bool IsTeacherSubmitting;

    private bool IsAdmin => Auth.IsAuthenticated && string.Equals(Auth.Role, "Admin", StringComparison.OrdinalIgnoreCase);

    private IEnumerable<Student> FilteredStudents => string.IsNullOrWhiteSpace(studentSearch)
        ? students
        : students.Where(s =>
            s.FirstName.Contains(studentSearch, StringComparison.OrdinalIgnoreCase) ||
            s.LastName.Contains(studentSearch, StringComparison.OrdinalIgnoreCase) ||
            s.Email.Contains(studentSearch, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<string> ClassroomGroups => classrooms
        .Select(c => c.GroupId)
        .Distinct()
        .OrderBy(g => g);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var teachersTask = Http.GetFromJsonAsync<List<Teacher>>("api/teachers");
        var studentsTask = Http.GetFromJsonAsync<List<Student>>("api/students");
        var classroomsTask = Http.GetFromJsonAsync<List<ClassroomSummaryDto>>("api/admin/classrooms");

        await Task.WhenAll(teachersTask, studentsTask, classroomsTask);

        teachers = teachersTask.Result ?? new();
        students = studentsTask.Result ?? new();
        classrooms = classroomsTask.Result ?? new();
    }

    private void ToggleStudent(int studentId)
    {
        if (assignment.StudentIds.Contains(studentId))
        {
            assignment.StudentIds.Remove(studentId);
        }
        else
        {
            assignment.StudentIds.Add(studentId);
        }
    }

    private async Task SubmitAssignment()
    {
        if (assignment.TeacherId == 0 || string.IsNullOrWhiteSpace(assignment.GroupId) || assignment.StudentIds.Count == 0)
        {
            StatusMessage = "Please choose a teacher, classroom, and at least one student.";
            IsError = true;
            return;
        }

        IsSubmitting = true;
        IsError = false;
        StatusMessage = null;

        var response = await Http.PostAsJsonAsync("api/admin/classrooms/assign", assignment);
        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Classroom saved.";
            assignment = new()
            {
                TeacherId = assignment.TeacherId,
                GroupId = assignment.GroupId,
                StudentIds = new List<int>(),
            };
            await LoadData();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to save classroom." : error;
            IsError = true;
        }

        IsSubmitting = false;
    }

    private async Task AddTeacherToClassroom()
    {
        if (teacherAssignment.TeacherId == 0 || string.IsNullOrWhiteSpace(teacherAssignment.GroupId))
        {
            TeacherStatusMessage = "Please choose both a teacher and a classroom.";
            TeacherIsError = true;
            return;
        }

        TeacherIsError = false;
        TeacherStatusMessage = null;
        IsTeacherSubmitting = true;

        var response = await Http.PostAsJsonAsync("api/admin/classrooms/teacher", teacherAssignment);
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<AddTeacherToClassroomResult>();
            var added = result?.Added ?? 0;
            var alreadyAssigned = result?.AlreadyAssigned ?? 0;

            TeacherStatusMessage = added > 0 || alreadyAssigned > 0
                ? $"Teacher added to classroom. Added {added} students; {alreadyAssigned} already assigned."
                : "Teacher added to classroom.";
            TeacherIsError = false;

            teacherAssignment = new()
            {
                TeacherId = 0,
                GroupId = string.Empty
            };
            await LoadData();
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            TeacherStatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to add teacher." : error;
            TeacherIsError = true;
        }

        IsTeacherSubmitting = false;
    }

    private class AddTeacherToClassroomResult
    {
        public int Added { get; set; }

        public int AlreadyAssigned { get; set; }
    }
}
