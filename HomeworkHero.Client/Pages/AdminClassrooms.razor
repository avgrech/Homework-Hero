@page "/admin/classrooms"
@inject HttpClient Http
@inject AuthState Auth

<h1>Classroom assignments</h1>
<p>Assign students to classroom groups and connect those classrooms to teachers.</p>

@if (!IsAdmin)
{
    <p class="text-error">You must be signed in as an admin to use this page.</p>
    <NavLink href="/login">Go to login</NavLink>
}
else
{
    <section class="card">
        <h2>Current classrooms</h2>
        @if (classrooms.Count == 0)
        {
            <p>No classroom assignments yet.</p>
        }
        else
        {
            <div class="grid">
                @foreach (var classroom in classrooms)
                {
                    <div class="callout">
                        <p class="muted">Group</p>
                        <h3>@classroom.GroupId</h3>
                        <p><strong>Teacher:</strong> @classroom.TeacherName</p>
                        <p><strong>Students:</strong></p>
                        @if (classroom.Students.Count == 0)
                        {
                            <p class="muted">No students assigned yet.</p>
                        }
                        else
                        {
                            <ul>
                                @foreach (var student in classroom.Students)
                                {
                                    <li>@student.FirstName @student.LastName</li>
                                }
                            </ul>
                        }
                    </div>
                }
            </div>
        }
    </section>

    <section class="card">
        <h2>Add a teacher to an existing classroom</h2>
        <p>Pair another teacher with a classroom without changing student assignments.</p>

        <div class="grid">
            <div>
                <label>Classroom / Group ID</label>
                <InputText @bind-Value="selectedClassroomGroup" list="classroom-options" @bind-Value:event="oninput" placeholder="Search classrooms" />
                <datalist id="classroom-options">
                    @foreach (var group in ClassroomGroups)
                    {
                        <option value="@group"></option>
                    }
                </datalist>
            </div>
            <div>
                <label>Teacher</label>
                <InputText @bind-Value="teacherSearch" placeholder="Search teachers" oninput="oninput" />
                <InputSelect @bind-Value="selectedTeacherId">
                    <option value="0">Select a teacher</option>
                    @foreach (var teacher in FilteredTeachers)
                    {
                        <option value="@teacher.Id">@teacher.FirstName @teacher.LastName (@teacher.Email)</option>
                    }
                </InputSelect>
            </div>
        </div>

        <div class="button-row">
            <button type="button" @onclick="AddTeacherToClassroom" disabled="@IsSubmitting">Add teacher</button>
        </div>
    </section>

    <section class="card">
        <h2>Edit a classroom</h2>
        <p>Update the classroom name or the primary teacher for classrooms created here.</p>

        <div class="grid">
            <div>
                <label>Classroom</label>
                <InputSelect @bind-Value="selectedEditClassroomId" @onchange="OnEditClassroomChanged">
                    <option value="0">Select a classroom</option>
                    @foreach (var classroom in EditableClassrooms)
                    {
                        <option value="@classroom.ClassroomId">@classroom.GroupId</option>
                    }
                </InputSelect>
            </div>
            <div>
                <label>Updated classroom name</label>
                <InputText @bind-Value="editGroupId" placeholder="Enter a new name" />
            </div>
            <div>
                <label>Primary teacher</label>
                <InputSelect @bind-Value="editTeacherId">
                    <option value="">Unassigned</option>
                    @foreach (var teacher in teachers)
                    {
                        <option value="@teacher.Id">@teacher.FirstName @teacher.LastName (@teacher.Email)</option>
                    }
                </InputSelect>
            </div>
        </div>

        <div class="button-row">
            <button type="button" @onclick="UpdateClassroom" disabled="@IsSubmitting">Update classroom</button>
        </div>
    </section>
}

@code {
    private List<Teacher> teachers = new();
    private List<ClassroomSummaryDto> classrooms = new();
    private string teacherSearch = string.Empty;

    private int selectedTeacherId;
    private string selectedClassroomGroup = string.Empty;
    private int selectedEditClassroomId;
    private string editGroupId = string.Empty;
    private int? editTeacherId;

    private string? StatusMessage;
    private bool IsError;
    private bool IsSubmitting;

    private bool IsAdmin => Auth.IsAuthenticated && string.Equals(Auth.Role, "Admin", StringComparison.OrdinalIgnoreCase);

    private IEnumerable<Teacher> FilteredTeachers => string.IsNullOrWhiteSpace(teacherSearch)
        ? teachers
        : teachers.Where(t =>
            t.FirstName.Contains(teacherSearch, StringComparison.OrdinalIgnoreCase) ||
            t.LastName.Contains(teacherSearch, StringComparison.OrdinalIgnoreCase) ||
            t.Email.Contains(teacherSearch, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<string> ClassroomGroups => classrooms
        .Select(c => c.GroupId)
        .Where(group => !string.IsNullOrWhiteSpace(group))
        .Distinct()
        .OrderBy(group => group);

    private IEnumerable<ClassroomSummaryDto> EditableClassrooms => classrooms
        .Where(c => c.ClassroomId.HasValue)
        .OrderBy(c => c.GroupId);

    protected override async Task OnInitializedAsync()
    {
        if (!IsAdmin)
        {
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        teachers = await FetchOrEmpty<Teacher>("api/teachers") ?? new();
        classrooms = await FetchOrEmpty<ClassroomSummaryDto>("api/admin/classrooms") ?? new();
    }

    private async Task<List<T>?> FetchOrEmpty<T>(string requestUri)
    {
        try
        {
            return await Http.GetFromJsonAsync<List<T>>(requestUri) ?? new();
        }
        catch
        {
            StatusMessage = $"Unable to load data from '{requestUri}'.";
            IsError = true;
            return new();
        }
    }

    private async Task AddTeacherToClassroom()
    {
        if (selectedTeacherId == 0 || string.IsNullOrWhiteSpace(selectedClassroomGroup))
        {
            StatusMessage = "Please choose a classroom and teacher.";
            IsError = true;
            return;
        }

        IsSubmitting = true;
        IsError = false;
        StatusMessage = null;

        var request = new CreateClassroomRequest
        {
            TeacherId = selectedTeacherId,
            GroupId = selectedClassroomGroup
        };

        var response = await Http.PostAsJsonAsync("api/admin/classrooms", request);
        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Teacher added to classroom.";
            await LoadData();
            selectedClassroomGroup = string.Empty;
            selectedTeacherId = 0;
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to add teacher to classroom." : error;
            IsError = true;
        }

        IsSubmitting = false;
    }

    private void OnEditClassroomChanged(ChangeEventArgs args)
    {
        if (args?.Value is null || !int.TryParse(args.Value.ToString(), out var classroomId))
        {
            selectedEditClassroomId = 0;
            editGroupId = string.Empty;
            editTeacherId = null;
            return;
        }

        selectedEditClassroomId = classroomId;
        var selected = classrooms.FirstOrDefault(c => c.ClassroomId == classroomId);
        if (selected is null)
        {
            editGroupId = string.Empty;
            editTeacherId = null;
            return;
        }

        editGroupId = selected.GroupId;
        editTeacherId = selected.TeacherId;
    }

    private async Task UpdateClassroom()
    {
        if (selectedEditClassroomId == 0 || string.IsNullOrWhiteSpace(editGroupId))
        {
            StatusMessage = "Please choose a classroom and enter a name.";
            IsError = true;
            return;
        }

        IsSubmitting = true;
        IsError = false;
        StatusMessage = null;

        var request = new UpdateClassroomRequest
        {
            GroupId = editGroupId,
            TeacherId = editTeacherId
        };

        var response = await Http.PutAsJsonAsync($"api/admin/classrooms/{selectedEditClassroomId}", request);
        if (response.IsSuccessStatusCode)
        {
            StatusMessage = "Classroom updated.";
            await LoadData();
            selectedEditClassroomId = 0;
            editGroupId = string.Empty;
            editTeacherId = null;
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            StatusMessage = string.IsNullOrWhiteSpace(error) ? "Unable to update classroom." : error;
            IsError = true;
        }

        IsSubmitting = false;
    }
}
