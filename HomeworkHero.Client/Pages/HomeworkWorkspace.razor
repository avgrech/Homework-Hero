@page "/homework-workspace/{Id:int}"
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http

<h1>Homework workspace</h1>
<p>Review the assignment on the right and use the chat to ask for help as you work.</p>

@if (isLoading)
{
    <p>Loading homework...</p>
}
else if (homework is null)
{
    <div class="card">
        <p>We couldn't find that homework item.</p>
    </div>
}
else
{
    <div class="workspace">
        <div class="workspace-pane chat-pane">
            <div class="pane-header">
                <h3>Chat</h3>
                <p class="muted">Send a question or update for the AI helper.</p>
            </div>
            <div class="chat-window">
                @foreach (var message in messages.OrderBy(m => m.Timestamp))
                {
                    <div class="chat-message @(message.IsUser ? "from-user" : "from-helper")">
                        <div class="chat-meta">
                            <strong>@message.Sender</strong>
                            <span>@message.Timestamp.ToLocalTime().ToString("g")</span>
                        </div>
                        <p>@message.Content</p>
                    </div>
                }
            </div>
            <EditForm Model="chatInput" OnValidSubmit="SendMessage">
                <DataAnnotationsValidator />
                <div class="chat-input">
                    <InputTextArea @bind-Value="chatInput.Message" placeholder="Ask for help or share your progress" />
                    <button type="submit">Send</button>
                </div>
            </EditForm>
        </div>
        <div class="workspace-pane homework-pane">
            <div class="pane-header">
                <h3>@homework.Title</h3>
                <div class="muted">Teacher: @TeacherName(homework) • Date given: @homework.DateAssigned • Due: @homework.DueDate</div>
            </div>
            <div class="card">
                <p>@homework.TextContent</p>
                @if (!string.IsNullOrWhiteSpace(homework.ImageUrl))
                {
                    <p><a href="@homework.ImageUrl" target="_blank">View attached reference</a></p>
                }
            </div>
        </div>
    </div>

    <div class="card submission-card">
        <h3>Submit homework</h3>
        <p class="muted">Attach a photo, document, or write your answer below.</p>
        <EditForm Model="submission" OnValidSubmit="SubmitHomework">
            <DataAnnotationsValidator />
            <div class="submission-grid">
                <div>
                    <label>Notes or answer</label>
                    <InputTextArea @bind-Value="submission.Notes" />
                </div>
                <div>
                    <label>Upload a file</label>
                    <InputFile OnChange="HandleFileSelected" />
                    @if (!string.IsNullOrWhiteSpace(submission.FileName))
                    {
                        <p class="muted">Selected: @submission.FileName (@submission.FileSizeKb KB)</p>
                    }
                </div>
            </div>
            <button type="submit">Submit homework</button>
        </EditForm>
        @if (!string.IsNullOrWhiteSpace(submissionStatus))
        {
            <p class="text-success">@submissionStatus</p>
        }
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private HomeworkItem? homework;
    private List<Teacher> teachers = new();
    private bool isLoading = true;

    private List<ChatMessage> messages = new()
    {
        new ChatMessage("AI helper", "Let me know where you need guidance and I'll do my best to help.")
    };

    private ChatInput chatInput = new();
    private HomeworkSubmission submission = new();
    private string submissionStatus = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        homework = await Http.GetFromJsonAsync<HomeworkItem>($"api/homework/{Id}");
        teachers = await Http.GetFromJsonAsync<List<Teacher>>("api/teachers") ?? new();
        isLoading = false;
    }

    private string TeacherName(HomeworkItem hw)
    {
        var teacher = teachers.FirstOrDefault(t => t.Id == hw.TeacherId);
        return teacher is null ? $"Teacher #{hw.TeacherId}" : $"{teacher.FirstName} {teacher.LastName}";
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(chatInput.Message))
        {
            return;
        }

        messages.Add(new ChatMessage("You", chatInput.Message.Trim(), DateTime.UtcNow, true));
        chatInput.Message = string.Empty;

        await Task.Delay(300); // placeholder for future AI call
        messages.Add(new ChatMessage("AI helper", "Thanks for the update! I'll review your message when the AI connection is ready."));
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null)
        {
            submission.FileName = null;
            submission.FileDataUrl = null;
            submission.FileSizeKb = null;
            return;
        }

        submission.FileName = file.Name;
        submission.FileSizeKb = (int)(file.Size / 1024);

        using var stream = file.OpenReadStream(2 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        submission.FileDataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}";
    }

    private Task SubmitHomework()
    {
        submissionStatus = "Submission saved. We'll send it to your teacher.";
        return Task.CompletedTask;
    }

    private record ChatMessage(string Sender, string Content, DateTime Timestamp, bool IsUser = false)
    {
        public ChatMessage(string sender, string content) : this(sender, content, DateTime.UtcNow)
        {
        }
    }

    private class ChatInput
    {
        [Required]
        [MaxLength(1000)]
        public string Message { get; set; } = string.Empty;
    }

    private class HomeworkSubmission
    {
        public string Notes { get; set; } = string.Empty;
        public string? FileName { get; set; }
        public string? FileDataUrl { get; set; }
        public int? FileSizeKb { get; set; }
    }
}
