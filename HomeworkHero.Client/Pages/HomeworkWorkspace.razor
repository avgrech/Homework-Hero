@page "/homework-workspace/{HomeworkId:int}"
@page "/homework-workspace"
@using System.ComponentModel.DataAnnotations
@using HomeworkHero.Shared.Models
@inject HttpClient Http
@inject AuthState Auth

<h1>Homework workspace</h1>
<p>Review the assignment, add your work, and use the chat to ask for help as you go.</p>

@if (isLoading)
{
    <p>Loading homework...</p>
}
else
{
    <div class="workspace-grid">
        <div class="workspace-column">
            @if (!string.IsNullOrWhiteSpace(loadError))
            {
                <div class="card">
                    <p>@loadError</p>
                </div>
            }
            else if (homework is null)
            {
                <div class="card">
                    <h3>Pick a homework to get started</h3>
                    <p class="muted">Use the homework list to the left or open a link from your teacher to see the assignment here.</p>
                </div>
            }
            else
            {
                <div class="workspace-pane homework-pane">
                    <div class="pane-header">
                        <h3>@homework.Title</h3>
                        <div class="muted">Teacher: @TeacherName(homework) • Date given: @homework.DateAssigned • Due: @homework.DueDate</div>
                    </div>
                    <div class="card">
                        <div class="homework-content">@RenderHtml(homework.TextContent)</div>
                        @if (!string.IsNullOrWhiteSpace(homework.ImageUrl))
                        {
                            <p><a href="@homework.ImageUrl" target="_blank">View attached reference</a></p>
                        }
                    </div>
                </div>

                <div class="card submission-card">
                    <h3>Turn in your work</h3>
                    <p class="muted">Share a clear response with any supporting files so your teacher can follow your thinking.</p>
                    <EditForm Model="submission" OnValidSubmit="SubmitHomework">
                        <DataAnnotationsValidator />
                        <div >
                            <div class="submission-notes">
                                <label>Notes or answer</label>
                                <InputTextArea @bind-Value="submission.Notes" class="notes-box" placeholder="Explain your steps or paste your answer here" />
                            </div>
                            <div class="submission-notes">
                                <label>Upload a file</label>
                                <InputFile OnChange="HandleFileSelected" />
                                @if (!string.IsNullOrWhiteSpace(submission.FileName))
                                {
                                    <p class="muted">Selected: @submission.FileName (@submission.FileSizeKb KB)</p>
                                }

                                <button type="submit" class="button-compact" disabled="@isSubmitting">@(isSubmitting ? "Submitting..." : "Submit homework")</button>
                            </div>
                        </div>
                        
                    </EditForm>
                    @if (!string.IsNullOrWhiteSpace(submissionStatus))
                    {
                        <p class="@(submissionHadError ? "text-error" : "text-success")">@submissionStatus</p>
                    }
                </div>
            }
        </div>
        <div class="workspace-column chat-column">
            <div class="workspace-pane chat-pane">
                <div class="pane-header">
                    <h3>Chat</h3>
                    <p class="muted">Send a question or update for the AI helper.</p>
                </div>
                <div class="chat-window">
                    @foreach (var message in messages.OrderBy(m => m.Timestamp))
                    {
                        <div class="chat-message @(message.IsUser ? "from-user" : "from-helper")">
                            <div class="chat-meta">
                                <strong>@message.Sender</strong>
                                <span>@message.Timestamp.ToLocalTime().ToString("g")</span>
                            </div>
                            <p>@message.Content</p>
                        </div>
                    }
                </div>
                <EditForm Model="chatInput" OnValidSubmit="SendMessage">
                    <DataAnnotationsValidator />
                    <div class="chat-input">
                        <InputTextArea @bind-Value="chatInput.Message" placeholder="Ask for help or share your progress" />
                        <button type="submit">Send</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "homeworkId")]
    public int? HomeworkId { get; set; }

    private HomeworkItem? homework;
    private List<Teacher> teachers = new();
    private bool isLoading = true;
    private string loadError = string.Empty;

    private List<ChatMessage> messages = new()
    {
        new ChatMessage("AI helper", "Let me know where you need guidance and I'll do my best to help.")
    };

    private ChatInput chatInput = new();
    private HomeworkSubmission submission = new();
    private string submissionStatus = string.Empty;
    private bool submissionHadError;
    private bool isSubmitting;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        loadError = string.Empty;
        homework = null;

        try
        {
            if (HomeworkId.HasValue && HomeworkId.Value > 0)
            {
                homework = await Http.GetFromJsonAsync<HomeworkItem>($"api/homework/{HomeworkId}");
            }
            else
            {
                loadError = "Pick a homework from the list to get started.";
            }

            teachers = await Http.GetFromJsonAsync<List<Teacher>>("api/teachers") ?? new();
        }
        catch (HttpRequestException)
        {
            loadError = "We couldn't load that homework right now. Please try again later.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string TeacherName(HomeworkItem hw)
    {
        var teacher = teachers.FirstOrDefault(t => t.Id == hw.TeacherId);
        return teacher is null ? $"Teacher #{hw.TeacherId}" : $"{teacher.FirstName} {teacher.LastName}";
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(chatInput.Message))
        {
            return;
        }

        var messageContent = chatInput.Message.Trim();
        messages.Add(new ChatMessage("You", messageContent, DateTime.UtcNow, true));
        chatInput.Message = string.Empty;

        var request = new LlmApiRequest
        {
            ChatHistory = new List<LlmChatHistory>
            {
                new()
                {
                    Role = "user",
                    Content = messageContent
                }
            }
        };

        try
        {
            var response = await Http.PostAsJsonAsync("api/LLM_Comunication", request);
            if (!response.IsSuccessStatusCode)
            {
                messages.Add(new ChatMessage("AI helper", "I couldn't reach the AI service. Please try again in a moment."));
                return;
            }

            var llmResponse = await response.Content.ReadFromJsonAsync<LlmApiResponse>();
            if (llmResponse is null || !llmResponse.Success || string.IsNullOrWhiteSpace(llmResponse.AssistantResponse))
            {
                messages.Add(new ChatMessage("AI helper", "I didn't receive a response from the AI service."));
                return;
            }

            messages.Add(new ChatMessage("AI helper", llmResponse.AssistantResponse));
        }
        catch (HttpRequestException)
        {
            messages.Add(new ChatMessage("AI helper", "I couldn't reach the AI service. Please check your connection and try again."));
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null)
        {
            submission.FileName = null;
            submission.FileSizeKb = null;
            submission.File = null;
            return;
        }

        submission.File = file;
        submission.FileName = file.Name;
        submission.FileSizeKb = (int)(file.Size / 1024);
    }

    private async Task SubmitHomework()
    {
        submissionStatus = string.Empty;
        submissionHadError = false;

        if (homework is null)
        {
            submissionStatus = "Select a homework item before submitting.";
            submissionHadError = true;
            return;
        }

        if (!Auth.StudentId.HasValue)
        {
            submissionStatus = "We couldn't find a student profile for this account.";
            submissionHadError = true;
            return;
        }

        isSubmitting = true;

        try
        {
            string? uploadedUrl = null;
            if (submission.File is not null)
            {
                using var content = new MultipartFormDataContent();
                await using var stream = submission.File.OpenReadStream(10 * 1024 * 1024);
                var fileContent = new StreamContent(stream);
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(submission.File.ContentType);
                content.Add(fileContent, "file", submission.File.Name);

                var uploadResponse = await Http.PostAsync("api/uploads", content);
                if (!uploadResponse.IsSuccessStatusCode)
                {
                    submissionStatus = "Upload failed. Please try again.";
                    submissionHadError = true;
                    return;
                }

                var uploadResult = await uploadResponse.Content.ReadFromJsonAsync<UploadResponse>();
                uploadedUrl = uploadResult?.Url;
            }

            var result = new HomeworkResult
            {
                StudentId = Auth.StudentId.Value,
                ResultText = string.IsNullOrWhiteSpace(submission.Notes) ? null : submission.Notes.Trim(),
                ResultImageUrl = uploadedUrl,
                SubmittedAt = DateTime.UtcNow
            };

            var response = await Http.PostAsJsonAsync($"api/homework/{homework.Id}/results", result);
            if (!response.IsSuccessStatusCode)
            {
                submissionStatus = "We couldn't submit your homework. Please try again.";
                submissionHadError = true;
                return;
            }

            submissionStatus = "Submission saved. We'll send it to your teacher.";
            submission = new HomeworkSubmission();
        }
        catch (Exception ex)
        {
            submissionStatus = $"Submission failed: {ex.Message}";
            submissionHadError = true;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private MarkupString RenderHtml(string? content)
    {
        if (string.IsNullOrWhiteSpace(content))
        {
            return new MarkupString(string.Empty);
        }

        return new MarkupString(content);
    }

    private record ChatMessage(string Sender, string Content, DateTime Timestamp, bool IsUser = false)
    {
        public ChatMessage(string sender, string content) : this(sender, content, DateTime.UtcNow)
        {
        }
    }

    private class ChatInput
    {
        [Required]
        [MaxLength(1000)]
        public string Message { get; set; } = string.Empty;
    }

    private class HomeworkSubmission
    {
        public string Notes { get; set; } = string.Empty;
        public string? FileName { get; set; }
        public IBrowserFile? File { get; set; }
        public int? FileSizeKb { get; set; }
    }

    private class UploadResponse
    {
        public string? Url { get; set; }
    }
}
